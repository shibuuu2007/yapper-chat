<!DOCTYPE html>
<html>
<head>
  <title>YAPPER</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');

    /* --- GLOBAL FIX: Keeps all sizes consistent --- */
    * { box-sizing: border-box; }

    body {
      margin: 0; overflow: hidden; font-family: 'JetBrains Mono', monospace; color: white;
      background: url('assets/background.png') no-repeat center center fixed; 
      background-size: cover; height: 100vh; display: flex; flex-direction: column;
    }

    /* --- 1. WELCOME OVERLAY (Restored) --- */
    #welcome-overlay {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      background: url('assets/welcome.png') no-repeat center center;
      background-size: cover;
      z-index: 9999;
      transition: opacity 0.8s ease-in-out, transform 0.8s ease-in-out;
    }

    /* INVISIBLE GHOST BUTTONS */
    .ghost-btn {
      position: absolute;
      height: 50px;  
      width: 225px;  
      background: transparent; 
      cursor: pointer;
      border: none;
    }
    #btn-login-ghost { top: 55%; left: 10%; }
    #btn-register-ghost { top: 55%; left: 33%; }

    /* --- 2. MAIN APP CONTAINER --- */
    #app-container {
      opacity: 0;
      transition: opacity 0.8s ease; 
      height: 100%;
      width: 100%;
      display: flex;
      flex-direction: column;
      pointer-events: none; /* Can't click until welcome fades */
    }

    /* GLASS EFFECT */
    .glass-panel { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 15px; }

    /* CENTER BOXES (Login & Lobby) */
    .center-box { 
        margin: auto; 
        padding: 40px; 
        text-align: center; 
        width: 350px; 
        position: relative; 
        display: flex; 
        flex-direction: column; 
        gap: 15px; 
    }

    /* BACK BUTTON (To go from Login back to Welcome) */
    .back-btn {
      position: absolute; top: 10px; left: 15px;
      background: transparent; border: none; color: #aaa;
      font-size: 1.5em; cursor: pointer; padding: 0; width: auto;
    }
    .back-btn:hover { color: white; }

    input { 
        width: 100%; padding: 12px; background: rgba(0,0,0,0.5); 
        border: 1px solid #555; color: white; border-radius: 5px; 
        outline: none; text-align: center; 
    }
    
    /* BUTTON STYLES (Fixed Alignment) */
    button { 
        width: 100%; padding: 12px; background: #ff007f; color: white; 
        border: none; font-weight: bold; cursor: pointer; border-radius: 5px; 
        text-transform: uppercase; transition: 0.2s; font-family: inherit;
    }
    button:hover { background: #d6006c; transform: scale(1.02); }
    button.secondary { background: #444; }
    button.secondary:hover { background: #666; }

    /* CHAT LAYOUT */
    #chat-container { display: none; height: 100vh; display: flex; }
    
    /* SIDEBAR */
    #sidebar { width: 250px; background: rgba(0,0,0,0.8); padding: 20px; border-right: 1px solid #333; display: flex; flex-direction: column; }
    #room-display { font-size: 2em; color: #ff007f; font-weight: bold; margin-bottom: 5px; }
    #user-list { list-style: none; padding: 0; margin-top: 20px; overflow-y: auto; }
    #user-list li { padding: 8px; border-bottom: 1px solid #333; color: #aaa; display: flex; align-items: center; }
    #user-list li::before { content: '●'; color: #00ff00; margin-right: 10px; font-size: 0.8em; }

    /* MAIN CHAT AREA */
    #main-chat { flex-grow: 1; display: flex; flex-direction: column; background: rgba(0,0,0,0.3); }
    #header { padding: 15px; display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.5); }
    #messages { flex-grow: 1; list-style: none; padding: 20px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; }
    #messages li { padding: 10px 15px; border-radius: 10px; background: rgba(0,0,0,0.6); max-width: 70%; width: fit-content; }
    #messages li.system { align-self: center; background: transparent; color: #ff007f; font-size: 0.8em; border: 1px solid #ff007f; }
    
    #form { padding: 20px; display: flex; gap: 10px; background: rgba(0,0,0,0.5); }
    #input-msg { flex-grow: 1; text-align: left; }

    .user-avatar { width: 40px; height: 40px; border-radius: 50%; border: 2px solid #ff007f; object-fit: cover; cursor: pointer; }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="welcome-overlay">
    <div id="btn-login-ghost" class="ghost-btn" onclick="enterApp('login')"></div>
    <div id="btn-register-ghost" class="ghost-btn" onclick="enterApp('register')"></div>
  </div>

  <div id="app-container">

      <div id="login-screen" class="center-box glass-panel">
        <button class="back-btn" onclick="goBack()" title="Back">←</button>
        <h2 id="auth-title">LOGIN</h2>
        <input id="u-name" placeholder="Username" autocomplete="off" />
        <input id="p-word" type="password" placeholder="Password" />
        <button id="auth-btn" onclick="handleAuth()">GO</button>
        <p id="status" style="color: #ff4d4d; font-size: 0.8em;"></p>
      </div>

      <div id="lobby-screen" class="center-box glass-panel hidden">
        <div style="display: flex; align-items: center; justify-content: center; gap: 10px;">
            <img id="lobby-avatar" class="user-avatar" src="">
            <h2 id="lobby-welcome">Welcome</h2>
        </div>
        <hr style="width: 100%; border: 0; border-top: 1px solid #555;">
        <h3>JOIN A ROOM</h3>
        <input id="room-code-input" placeholder="Enter 4-Char Code" maxlength="4" style="text-transform: uppercase; letter-spacing: 3px; font-weight: bold;">
        <button onclick="joinRoom()">JOIN ROOM</button>
        <p>— OR —</p>
        <button class="secondary" onclick="createRoom()">CREATE NEW ROOM</button>
        <button class="secondary" onclick="location.reload()" style="background: black; margin-top:10px;">LOGOUT</button>
      </div>

      <div id="chat-container" class="hidden">
        <div id="sidebar">
          <small>CURRENT ROOM</small>
          <div id="room-display">----</div>
          <small style="margin-top: 20px;">ONLINE USERS</small>
          <ul id="user-list"></ul>
          <div style="margin-top: auto;">
            <button onclick="leaveRoom()" style="width: 100%; background: #333;">LEAVE ROOM</button>
          </div>
        </div>

        <div id="main-chat">
          <div id="header">
            <div style="display: flex; align-items: center;">
                 <input type="file" id="avatar-input" hidden accept="image/*"> 
                <input type="file" id="wallpaper-input" hidden accept="image/*">
                <img id="header-avatar" class="user-avatar" src="" onclick="document.getElementById('avatar-input').click()" title="Change Profile Pic">
                <span id="header-username" style="font-weight: bold; margin-left: 10px;">User</span>
            </div>
            <button onclick="document.getElementById('wallpaper-input').click()" style="padding: 5px 10px; font-size: 0.8em; width: auto;">BG</button>
          </div>

          <ul id="messages"></ul>

          <form id="form" onsubmit="event.preventDefault(); sendMessage();">
            <input id="input-msg" autocomplete="off" placeholder="Type a message..." />
            <button style="width: auto;">SEND</button>
          </form>
        </div>
      </div>

  </div>

  <script src="https://yapper-chat.onrender.com/socket.io/socket.io.js"></script>
  <script>
    const SERVER_URL = "https://yapper-chat.onrender.com";
    const socket = io(SERVER_URL);

    let currentUser = null;
    let currentRoom = null;
    let currentMode = 'login'; // Track login vs register

    // --- TRANSITION: WELCOME -> APP ---
    function enterApp(mode) {
      currentMode = mode;
      
      // Update Title & Button Text
      const text = mode.toUpperCase();
      document.getElementById('auth-title').innerText = text === 'REGISTER' ? 'REGISTER' : 'LOGIN';
      document.getElementById('auth-btn').innerText = text === 'REGISTER' ? 'REGISTER' : 'LOGIN';
      
      // Fade Animation
      const overlay = document.getElementById('welcome-overlay');
      overlay.style.opacity = '0';
      overlay.style.transform = 'scale(1.1)'; 
      overlay.style.pointerEvents = 'none'; 

      const app = document.getElementById('app-container');
      app.style.opacity = '1';
      app.style.pointerEvents = 'all'; 
    }

    function goBack() {
      // Fade Back to Welcome
      const app = document.getElementById('app-container');
      app.style.opacity = '0';
      app.style.pointerEvents = 'none';

      const overlay = document.getElementById('welcome-overlay');
      overlay.style.opacity = '1';
      overlay.style.transform = 'scale(1)';
      overlay.style.pointerEvents = 'all';
    }

    // --- SCREEN SWITCHING (Within App) ---
    function showScreen(screenId) {
        ['login-screen', 'lobby-screen', 'chat-container'].forEach(id => {
            document.getElementById(id).classList.add('hidden');
        });
        document.getElementById(screenId).classList.remove('hidden');
        if(screenId === 'chat-container') document.getElementById('chat-container').style.display = 'flex';
    }

    // --- AUTH LOGIC ---
    async function handleAuth() {
        const u = document.getElementById('u-name').value;
        const p = document.getElementById('p-word').value;
        if(!u || !p) return;

        const endpoint = currentMode === 'login' ? '/login' : '/register';

        const res = await fetch(SERVER_URL + endpoint, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ username: u, password: p }) 
        });
        const data = await res.json();

        if (data.success) {
            if (currentMode === 'register') {
                alert("Registered! Now Login.");
                // Switch mode to login automatically
                currentMode = 'login';
                document.getElementById('auth-title').innerText = "LOGIN";
                document.getElementById('auth-btn').innerText = "LOGIN";
            } else {
                currentUser = data.username;
                applyUserAssets(data);
                
                // Show Lobby
                document.getElementById('lobby-welcome').innerText = currentUser;
                showScreen('lobby-screen');
            }
        } else {
            document.getElementById('status').innerText = data.message;
        }
    }

    function applyUserAssets(data) {
        const pic = data.profile_pic || "https://cdn-icons-png.flaticon.com/512/847/847969.png";
        document.getElementById('lobby-avatar').src = pic;
        document.getElementById('header-avatar').src = pic;
        document.getElementById('header-username').innerText = currentUser;

        if (data.wallpaper) {
            const bg = data.wallpaper.startsWith('#') ? data.wallpaper : `url(${data.wallpaper})`;
            document.body.style.background = bg;
            document.body.style.backgroundSize = "cover";
        }
    }

    // --- ROOM LOGIC ---
    function createRoom() {
        const code = Math.random().toString(36).substring(2, 6).toUpperCase();
        enterRoom(code);
    }

    function joinRoom() {
        const code = document.getElementById('room-code-input').value.toUpperCase();
        if (code.length < 1) return alert("Enter a code!");
        enterRoom(code);
    }

    function enterRoom(code) {
        currentRoom = code;
        document.getElementById('room-display').innerText = code;
        document.getElementById('messages').innerHTML = ''; 
        socket.emit('join_room', { username: currentUser, room: code });
        showScreen('chat-container');
    }

    // --- LEAVE ROOM (FIXED) ---
    function leaveRoom() {
        socket.emit('leave_room');
        document.getElementById('messages').innerHTML = '';
        document.getElementById('user-list').innerHTML = '';
        document.getElementById('room-display').innerText = '----';
        currentRoom = null;
        showScreen('lobby-screen');
    }

    // --- CHAT LOGIC ---
    function sendMessage() {
        const input = document.getElementById('input-msg');
        if (input.value) {
            socket.emit('chat message', { user: currentUser, text: input.value });
            addMessage({ user: currentUser, text: input.value }); 
            input.value = '';
        }
    }

    socket.on('chat message', (msg) => {
        if(msg.user !== currentUser) addMessage(msg);
    });

    socket.on('system_message', (text) => {
        const li = document.createElement('li');
        li.classList.add('system');
        li.innerText = text;
        document.getElementById('messages').appendChild(li);
    });

    socket.on('room_users', (users) => {
        const list = document.getElementById('user-list');
        list.innerHTML = '';
        users.forEach(u => {
            const li = document.createElement('li');
            li.innerText = u;
            list.appendChild(li);
        });
    });

    function addMessage(msg) {
        const li = document.createElement('li');
        li.innerHTML = `<strong style="color:#ff007f">${msg.user}:</strong> ${msg.text}`;
        document.getElementById('messages').appendChild(li);
        document.getElementById('messages').scrollTop = document.getElementById('messages').scrollHeight;
    }

    // --- UPLOADS ---
    ['avatar', 'wallpaper'].forEach(type => {
        document.getElementById(`${type}-input`).addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            const formData = new FormData();
            formData.append(type, file);
            formData.append('username', currentUser);
            
            const res = await fetch(`${SERVER_URL}/upload-${type === 'avatar' ? 'profile-pic' : 'wallpaper-image'}`, { method: 'POST', body: formData });
            const data = await res.json();
            
            if(data.success) {
                if(type === 'avatar') {
                    document.getElementById('header-avatar').src = data.url;
                    document.getElementById('lobby-avatar').src = data.url;
                } else {
                    document.body.style.background = `url(${data.url}) no-repeat center center fixed`;
                    document.body.style.backgroundSize = "cover";
                }
            }
        });
    });
  </script>
</body>
</html>